<!-- 弹框HTML结构 -->
<div id="todo-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 transition-opacity duration-200">
    <div id="todo-modal-panel" class="bg-white rounded-lg p-6 w-[650px] shadow-xl transform scale-95 transition-transform duration-200">
        <h3 class="text-lg font-medium mb-4 text-slate-800" id="modal-title">处理患者待办</h3>
        
        <div class="mb-4">
            <div class="flex items-center mb-2 justify-between">
            <label class="block text-sm font-medium text-slate-700 mb-1">待处理事件</label>
            <button type="button" id="view-indicators-btn" class="text-rose-500 text-sm hover:text-rose-600 transition">查看指标></button></div>
            <div id="event-title" class="p-2 bg-slate-50 rounded text-slate-800 font-medium border border-slate-100"></div>
            <div id="event-content" class="p-2 bg-slate-50 rounded mt-1 text-sm text-slate-600 border border-slate-100"></div>
        </div>
        
        <div class="mb-4">
            <label for="event-handle" class="block text-sm font-medium text-slate-700 mb-1">事件处理情况 <span class="text-rose-500" id="handle-required-mark">*</span></label>
            <textarea id="event-handle" class="w-full p-2 border border-slate-300 rounded focus:ring-rose-500 focus:border-rose-500 outline-none transition disabled:bg-slate-50 disabled:text-slate-500" rows="3" required placeholder="请填写处理详情..."></textarea>
        </div>
        
        <div class="mb-6">
            <label for="event-status" class="block text-sm font-medium text-slate-700 mb-1">事件状态 <span class="text-rose-500" id="status-required-mark">*</span></label>
            <select id="event-status" class="w-full p-2 border border-slate-300 rounded focus:ring-rose-500 focus:border-rose-500 outline-none bg-white disabled:bg-slate-50 disabled:text-slate-500">
                <option value="" disabled selected>请选择状态</option>
                <option value="pending">待跟进</option>
                <option value="escalate">升级主任</option>
                <option value="completed">已完成</option>
            </select>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button id="cancel-btn" class="px-4 py-2 border border-slate-300 rounded text-slate-600 hover:bg-slate-50 transition">取消</button>
            <button id="save-btn" class="px-4 py-2 bg-rose-600 text-white rounded hover:bg-rose-700 transition shadow-sm">保存</button>
        </div>
    </div>
</div>

<script>
    /** 
     * @param {Object} itemData - 列表项数据 
     * @param {Boolean} isEditMode - 是否编辑模式 
     * @param {Function} onSave - 保存回调函数 
     */ 
    window.showTodoModal = function(itemData, isEditMode, onSave) {
        // 保存当前操作的数据ID和回调
        const currentItemId = itemData.id;
        window.__todoModalContext = {
            patientId: itemData.patient_id || null,
            indicatorsQuery: {
                filter_type: "cycle"
            }
        };
        
        // 填充数据
        $('#event-title').text(itemData.title || '');
        $('#event-content').text(itemData.content || '');
        
        // 根据模式设置界面
        if (isEditMode) {
            // 编辑模式
            $('#modal-title').text('处理患者待办');
            $('#event-handle').val('').prop('disabled', false);
            $('#event-status').val('pending').prop('disabled', false); // 默认为待跟进
            $('#save-btn').removeClass('hidden');
            $('#cancel-btn').text('取消');
            $('#handle-required-mark').removeClass('hidden');
            $('#status-required-mark').removeClass('hidden');
            
            // 绑定保存事件
            $('#save-btn').off('click').on('click', function() {
                const handleContent = $('#event-handle').val().trim();
                const status = $('#event-status').val();
                
                if (!handleContent) {
                    alert('请填写事件处理情况');
                    return;
                }
                
                if (!status) {
                    alert('请选择事件状态');
                    return;
                }
                
                const newData = {
                    id: currentItemId,
                    handle_content: handleContent,
                    status: status
                };
                
                console.log('保存数据:', newData);
                
                // 发送请求
                fetch("{% url 'web_doctor:doctor_todo_update_status' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(newData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (typeof onSave === 'function') {
                            onSave(newData);
                        }
                        closeModal();
                        
                        // 触发列表刷新
                        // 1. 如果在待办列表页，刷新表格
                        if (document.getElementById('todo-filter-form')) {
                             htmx.trigger('#todo-filter-form', 'submit');
                             
                             // 标记数据已变更，用于返回上一页时刷新
                             sessionStorage.setItem('todo_needs_refresh', 'true');
                             
                             // 同时通知其他页面（如首页）数据已更新
                             const channel = new BroadcastChannel('app-events');
                             channel.postMessage({ type: 'todo-updated' });
                             channel.close();
                        } 
                        // 2. 如果在首页，尝试局部刷新侧边栏
                        else {
                            if (itemData.patient_id) {
                                // 使用 HTMX 请求侧边栏局部视图
                                // 由于视图返回了 OOB 内容，这里不需要指定 target，或者指定 swap:none
                                const url = `/doctor/workspace/patient/${itemData.patient_id}/todo-sidebar/`;
                                htmx.ajax('GET', url, {swap: 'none'});
                            } else {
                                // 如果没有 patient_id（理论上首页选中患者后会有），回退到刷新页面
                                window.location.reload();
                            }
                        }
                    } else {
                        alert('保存失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('网络请求失败，请稍后重试');
                });
            });
            
        } else {
            // 查看模式
            $('#modal-title').text('查看待办详情');
            $('#event-handle').val(itemData.handle_content || '').prop('disabled', true);
            $('#event-status').val(itemData.status || '').prop('disabled', true);
            $('#save-btn').addClass('hidden');
            $('#cancel-btn').text('关闭');
            $('#handle-required-mark').addClass('hidden');
            $('#status-required-mark').addClass('hidden');
        }
        
        // 显示弹框
        openModal();
    };

    function openModal() {
        const modal = document.getElementById('todo-modal');
        const panel = document.getElementById('todo-modal-panel');
        if (!modal) return;

        modal.classList.remove('hidden');
        requestAnimationFrame(function() {
            modal.style.opacity = '1';
            if (panel) panel.style.transform = 'scale(1)';
        });
    }

    function closeModalAsync() {
        return new Promise(function(resolve) {
            const modal = document.getElementById('todo-modal');
            const panel = document.getElementById('todo-modal-panel');
            if (!modal) {
                resolve();
                return;
            }

            const finish = function() {
                modal.classList.add('hidden');
                modal.removeEventListener('transitionend', onEnd);
                resolve();
            };

            const onEnd = function(e) {
                if (e.target === modal) {
                    finish();
                }
            };

            modal.addEventListener('transitionend', onEnd);
            modal.style.opacity = '0';
            if (panel) panel.style.transform = 'scale(0.95)';
            window.setTimeout(finish, 260);
        });
    }

    function closeModal() {
        closeModalAsync();
    }

    /**
     * 辅助函数：处理按钮点击，从 dataset 获取数据并打开弹框
     * @param {HTMLElement} btn - 点击的按钮元素
     * @param {Boolean} isEditMode - 是否编辑模式
     */
    window.handleTodoModalTrigger = function(btn, isEditMode) {
        const dataset = btn.dataset;
        const entry = dataset.entrySource || (document.getElementById('todo-filter-form') ? 'todo_list' : 'home');
        try {
            sessionStorage.setItem('todo_modal_entry', entry);
        } catch (e) {}
        const itemData = {
            id: dataset.todoId,
            title: dataset.todoTitle,
            content: dataset.todoContent,
            status: dataset.todoStatus,
            handle_content: dataset.todoHandleContent,
            patient_id: dataset.patientId
        };
        
        showTodoModal(itemData, isEditMode, function(data) {
            // alert('保存成功（模拟）：' + JSON.stringify(data));
            // 保存逻辑已移至 showTodoModal 内部
        });
    };

    // 初始化事件绑定
    $(document).ready(function() {
        // 取消按钮
        $('#cancel-btn').click(function() {
            closeModal();
        });

        window.goToPatientIndicators = function(payload) {
            const patientId = payload && payload.patientId ? String(payload.patientId) : '';
            const query = payload && payload.query ? String(payload.query) : '';
            if (!patientId) {
                alert('未获取到患者ID，无法跳转指标');
                return;
            }

            const ensureLoadingOverlay = function() {
                if (document.getElementById('workspace-loading-overlay')) return null;
                if (document.getElementById('todo-nav-loading-overlay')) return document.getElementById('todo-nav-loading-overlay');
                const overlay = document.createElement('div');
                overlay.id = 'todo-nav-loading-overlay';
                overlay.className = 'fixed inset-0 z-50 flex items-center justify-center bg-white/80 backdrop-blur-sm';
                overlay.innerHTML = '<div class="flex flex-col items-center justify-center text-center px-6 py-10 text-slate-500"><p class="text-sm font-medium text-slate-600">加载中...</p></div>';
                document.body.appendChild(overlay);
                return overlay;
            };

            const removeLoadingOverlay = function(overlay) {
                if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
            };

            const htmxGet = function(url, targetSelector, indicatorSelector) {
                return new Promise(function(resolve, reject) {
                    if (!window.htmx) {
                        reject(new Error('htmx not found'));
                        return;
                    }
                    const elt = document.createElement('a');
                    elt.href = '#';
                    elt.style.display = 'none';
                    elt.setAttribute('hx-get', url);
                    elt.setAttribute('hx-target', targetSelector);
                    elt.setAttribute('hx-swap', 'innerHTML');
                    elt.setAttribute('hx-request', '{"timeout": 10000}');
                    if (indicatorSelector) {
                        elt.setAttribute('hx-indicator', indicatorSelector);
                    }
                    document.body.appendChild(elt);
                    window.htmx.process(elt);

                    const handler = function(evt) {
                        if (!evt.detail || evt.detail.elt !== elt) return;
                        document.body.removeEventListener('htmx:afterRequest', handler);
                        elt.remove();
                        if (evt.detail.successful) {
                            resolve();
                        } else {
                            reject(new Error('request failed'));
                        }
                    };
                    document.body.addEventListener('htmx:afterRequest', handler);

                    elt.click();
                });
            };

            const indicatorsUrl = '/doctor/workspace/patient/' + patientId + '/indicators/' + (query ? ('?' + query) : '');
            const hasPatientContent = !!document.getElementById('patient-content');
            if (hasPatientContent) {
                htmxGet(indicatorsUrl, '#patient-content', '#workspace-loading-overlay').catch(function() {
                    alert('加载患者指标失败，请稍后重试');
                });
                return;
            }

            const overlay = ensureLoadingOverlay();
            const workspaceUrl = '/doctor/workspace/patient/' + patientId + '/';
            htmxGet(workspaceUrl, '#main-content', null)
                .then(function() {
                    removeLoadingOverlay(overlay);
                    return htmxGet(indicatorsUrl, '#patient-content', '#workspace-loading-overlay');
                })
                .catch(function() {
                    removeLoadingOverlay(overlay);
                    alert('加载患者工作区失败，请稍后重试');
                });
        };

        $('#view-indicators-btn').click(function() {
            const ctx = window.__todoModalContext || {};
            const patientId = ctx.patientId;
            const query = ctx.indicatorsQuery ? new URLSearchParams(ctx.indicatorsQuery).toString() : '';
            const entry = (function() {
                try {
                    return sessionStorage.getItem('todo_modal_entry') || 'home';
                } catch (e) {
                    return 'home';
                }
            })();

            closeModalAsync().then(function() {
                if (!patientId) {
                    alert('未获取到患者ID，无法跳转指标');
                    return;
                }
                if (entry === 'todo_list') {
                    try {
                        sessionStorage.setItem('todo_pending_jump', JSON.stringify({
                            action: 'indicators',
                            patientId: String(patientId),
                            query: query
                        }));
                    } catch (e) {}
                    window.history.back();
                    return;
                }
                window.goToPatientIndicators({ patientId: patientId, query: query });
            });
        });
        
        // 点击遮罩层关闭
        $('#todo-modal').click(function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // ESC键关闭
        $(document).keydown(function(e) {
            if (e.key === "Escape" && !$('#todo-modal').hasClass('hidden')) {
                closeModal();
            }
        });
    });
</script>
