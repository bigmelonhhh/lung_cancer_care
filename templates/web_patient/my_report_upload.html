{% extends "layouts/base_portal.html" %}
{% load static %}

{% block body %}
<div class="min-h-screen bg-[#F5F7FA] flex flex-col">
    <!-- Header -->
    <div class="bg-white sticky top-0 z-30 border-b border-gray-100 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-3 flex items-center gap-3">
            <div onclick="window.history.back()"   class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-lg font-bold text-gray-900">新增报告</h1>
        </div>
    </div>

    <form id="upload-form" class="flex-1 flex flex-col max-w-4xl mx-auto w-full">
        {% csrf_token %}
        <div class="p-4 space-y-4 flex-1">
            <!-- Error/Status Message Area -->
            <div id="status-message" class="hidden w-full p-3 rounded-lg text-sm font-medium mb-4 text-center"></div>

            <!-- Date Input -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <label class="block text-sm font-medium text-gray-500 mb-2">上传日期</label>
                <div class="flex items-center border-gray-200 pb-1">
                    <input type="date" name="report_date" value="{{ today }}" class="w-full border p-2 rounded text-gray-900 focus:ring-blue-500 focus:border-blue-500 text-lg bg-transparent font-medium" required>
                </div>
            </div>

            <!-- Image Upload -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <p class="text-sm font-medium text-gray-500 mb-3">报告图片</p>
                <div class="grid grid-cols-3 sm:grid-cols-4 gap-3" id="image-preview-container">
                    <!-- Images will be inserted here -->
                    
                    <!-- Upload Button -->
                    <label class="aspect-square bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 transition active:scale-95 text-gray-400 hover:text-gray-600 hover:border-gray-300" id="upload-btn">
                        <svg class="w-8 h-8 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <input type="file" id="file-input" multiple accept="image/*" class="hidden" onchange="handleFileChange(event)">
                    </label>
                </div>
                <p class="text-xs text-gray-400 mt-3">支持上传多张图片，每张不超过 10MB</p>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="p-4 bg-white border-t border-gray-100 sticky bottom-0 z-20">
            <button type="button" onclick="submitReport()" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 active:scale-[0.98] transition flex items-center justify-center gap-2">
                <span>提交</span>
            </button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
<script src="{% static 'web_patient/image_compression.js' %}"></script>
<script>
// State to store uploaded files
let uploads = [];
const compressQueue = [];
let compressActiveCount = 0;

const formatBytes = (window.LCCImageCompression && window.LCCImageCompression.formatBytes)
    ? window.LCCImageCompression.formatBytes
    : (bytes) => `${bytes || 0}B`;

function isOriginalUploadEnabled() { return false; }

function updateCompressStatus(text) {
    if (!text) {
        const statusEl = document.getElementById('status-message');
        if (statusEl) statusEl.classList.add('hidden');
        return;
    }
    showStatus(text, 'info');
}

function runCompressQueue() {
    if (compressActiveCount >= 2) return;
    const task = compressQueue.shift();
    if (!task) return;
    compressActiveCount += 1;
    task()
        .catch(() => {})
        .finally(() => {
            compressActiveCount -= 1;
            if (compressQueue.length === 0 && compressActiveCount === 0) {
                updateCompressStatus('');
            }
            runCompressQueue();
        });
}

function enqueueCompressTask(fn) {
    compressQueue.push(fn);
    runCompressQueue();
}

function handleFileChange(event) {
    const fileList = event.target.files;
    if (!fileList || fileList.length === 0) return;
    
    const files = Array.from(fileList);
    event.target.value = ''; // Reset input
    
    updateCompressStatus('正在压缩图片...');

    files.forEach((file) => {
        if (!file.type || !file.type.startsWith('image/')) {
            showStatus(`文件 ${file.name} 格式不支持，请上传图片`, 'error');
            return;
        }
        const lowerName = (file.name || '').toLowerCase();
        const isJpeg = file.type === 'image/jpeg' || lowerName.endsWith('.jpg') || lowerName.endsWith('.jpeg');
        const isPng = file.type === 'image/png' || lowerName.endsWith('.png');
        if (!isJpeg && !isPng) {
            showStatus(`文件 ${file.name} 格式不支持，请上传JPG/PNG图片`, 'error');
            return;
        }
        if (file.size > 10 * 1024 * 1024) {
            showStatus(`文件 ${file.name} 超过10MB限制`, 'error');
            return;
        }

        const fileId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const originalUrl = URL.createObjectURL(file);
        const originalUpload = false;
        uploads.push({
            id: fileId,
            file: file,
            originalSize: file.size,
            compressedSize: file.size,
            fileName: file.name,
            usedOriginal: originalUpload,
            policy: null,
            networkInfo: null,
        });
        addPreviewElement(originalUrl, fileId, { originalSize: file.size, compressedSize: file.size, statusText: '压缩中...' });

        enqueueCompressTask(async () => {
            let progress = 0;
            const onProgress = (p) => {
                progress = p;
                updateCompressStatus(`正在压缩图片...(${Math.min(99, Math.max(0, Math.floor(p)))}%)`);
            };
            try {
                const result = await window.LCCImageCompression.compressOne(file, { allowOriginal: true, timeoutMs: 30_000, onProgress, preScaleTo1080p: true });
                const outFile = result.file;
                const usedOriginal = !!result.usedOriginal;
                const compressedSize = outFile.size;
                const entry = uploads.find(x => x.id === fileId);
                if (entry) {
                    entry.file = outFile;
                    entry.compressedSize = compressedSize;
                    entry.usedOriginal = usedOriginal;
                    entry.policy = result.policy || null;
                    entry.networkInfo = result.networkInfo || null;
                }
                const wrapper = document.getElementById(`preview-${fileId}`);
                if (wrapper) {
                    const img = wrapper.querySelector('img');
                    if (img && img.src) URL.revokeObjectURL(img.src);
                    const newUrl = URL.createObjectURL(outFile);
                    if (img) img.src = newUrl;
                    const sizeEl = wrapper.querySelector('[data-role="size"]');
                    if (sizeEl) sizeEl.textContent = `${formatBytes(file.size)} → ${formatBytes(compressedSize)}`;
                    const statusEl = wrapper.querySelector('[data-role="status"]');
                    if (statusEl) statusEl.textContent = usedOriginal ? '未压缩' : (compressedSize <= 500 * 1024 ? '已压缩' : '已压缩(>阈值)');
                }
                if (!usedOriginal && compressedSize > 500 * 1024) {
                    showStatus(`图片 ${file.name} 压缩后仍超过500KB，已尽力压缩`, 'info');
                }
            } catch (err) {
                const entry = uploads.find(x => x.id === fileId);
                if (entry) entry.failed = true;
                const wrapper = document.getElementById(`preview-${fileId}`);
                if (wrapper) {
                    const statusEl = wrapper.querySelector('[data-role="status"]');
                    if (statusEl) statusEl.textContent = '压缩失败';
                }
                if (err && err.message === 'compress_timeout') {
                    showStatus(`图片 ${file.name} 压缩超时(30秒)，将使用原图上传`, 'error');
                } else {
                    showStatus(`图片 ${file.name} 压缩失败，将使用原图上传`, 'error');
                }
            } finally {
                if (progress >= 99) updateCompressStatus('正在压缩图片...');
            }
        });
    });
}

function addPreviewElement(url, fileId, meta) {
    const container = document.getElementById('image-preview-container');
    const uploadBtn = document.getElementById('upload-btn');
    
    const div = document.createElement('div');
    div.id = `preview-${fileId}`;
    div.className = 'aspect-square bg-gray-100 rounded-xl overflow-hidden relative group border border-gray-200';
    
    const img = document.createElement('img');
    img.src = url;
    img.className = 'w-full h-full object-cover';

    const badge = document.createElement('div');
    badge.className = 'absolute left-2 bottom-2 right-2 bg-black/60 text-white text-[10px] leading-tight px-2 py-1 rounded';
    const sizeText = (meta && (meta.originalSize || meta.originalSize === 0))
        ? `${formatBytes(meta.originalSize)} → ${formatBytes(meta.compressedSize)}`
        : '';
    const statusText = meta && meta.statusText ? meta.statusText : '';
    badge.innerHTML = `
        <div data-role="size">${sizeText}</div>
        <div data-role="status">${statusText}</div>
    `;
    
    // Delete Button
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'absolute top-2 right-2 w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center opacity-90 hover:opacity-100 hover:scale-110 transition-all shadow-md z-10';
    deleteBtn.innerHTML = '<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
    deleteBtn.onclick = function(e) {
        e.stopPropagation();
        removeFile(fileId);
    };
    
    div.appendChild(img);
    div.appendChild(badge);
    div.appendChild(deleteBtn);
    
    container.insertBefore(div, uploadBtn);
}

function removeFile(fileId) {
    if (confirm("确定要移除这张图片吗？")) {
        uploads = uploads.filter(item => item.id !== fileId);
        const wrapper = document.getElementById(`preview-${fileId}`);
        if (wrapper) {
            const img = wrapper.querySelector('img');
            if (img && img.src) URL.revokeObjectURL(img.src);
            wrapper.remove();
        }
    }
}

function submitReport() {
    if (compressActiveCount > 0 || (compressQueue && compressQueue.length > 0)) {
        showStatus('请等待图片压缩完成后再提交', 'info');
        return;
    }

    if (uploads.length === 0) {
        alert("请至少上传一张图片");
        return;
    }
    
    const reportDate = document.querySelector('input[name="report_date"]').value;
    if (!reportDate) {
        alert("请选择上传日期");
        return;
    }

    const formData = new FormData();
    formData.append('report_date', reportDate);
    
    uploads.forEach(u => {
        formData.append('images', u.file);
    });
    try {
        const networkInfo = window.LCCImageCompression ? window.LCCImageCompression.getNetworkInfo() : {};
        const meta = {
            page: 'my_report_upload',
            strategy: 'tiered_network_v1',
            original_upload: false,
            network: networkInfo,
            files: uploads.map(u => ({
                name: u.fileName || (u.file && u.file.name) || '',
                type: (u.file && u.file.type) || '',
                original_bytes: u.originalSize || 0,
                compressed_bytes: u.compressedSize || (u.file && u.file.size) || 0,
                used_original: !!u.usedOriginal,
                policy: u.policy || null,
                network: u.networkInfo || null,
            })),
        };
        formData.append('upload_meta', JSON.stringify(meta));
    } catch (e) {}
    
    const submitBtn = document.querySelector('button[onclick="submitReport()"]');
    const originalText = submitBtn.innerText;
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        提交中...
    `;

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("{% url 'web_patient:report_upload' %}", {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => {
        if (response.ok) {
            showStatus('上传成功', 'success');
            
            // 设置刷新标志，用于上一页数据刷新
            localStorage.setItem('refresh_report_list', 'true');
            
            setTimeout(() => {
                // 优先返回上一页
                    history.back();
            }, 500);
        } else {
            throw new Error('Upload failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showStatus('上传失败，请重试', 'error');
        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
    });
}

function showStatus(message, type) {
    const statusEl = document.getElementById('status-message');
    statusEl.textContent = message;
    statusEl.className = `w-full p-3 rounded-lg text-sm font-medium mb-4 text-center ${
        type === 'error' ? 'bg-red-100 text-red-700 border border-red-200' : 
        type === 'success' ? 'bg-green-100 text-green-700 border border-green-200' : 
        'bg-blue-100 text-blue-700 border border-blue-200'
    }`;
    statusEl.classList.remove('hidden');
    
    if (type !== 'info') {
        setTimeout(() => {
            statusEl.classList.add('hidden');
        }, 3000);
    }
}
</script>
{% endblock %}
